import ContactFormSubmission from "../models/contactForm.model.js";
import nodemailer from "nodemailer";
import dotenv from "dotenv";

dotenv.config();

// create transporter for nodemailer
const transporter = nodemailer.createTransport({
    service: "gmail",
    auth: {
        user: process.env.APP_EMAIL, // The email that sends the mail
        pass: process.env.APP_PASSWORD, // The App Password generated by Google
    },
});

// submit contact form
const submitContactForm = async (req, res) => {
    try {
        //  Save the form data to the database first
        const newSubmission = await ContactFormSubmission.create(req.body);

        //  Extract the data needed for the email from req.body
        const { name, email, phone, businessType , projectDetails } = req.body;
        // can be validated here 

        //  Define the email content with dynamic data
        const mailOptions = {
            from: `"StackCart_Space Contact Form" <${process.env.APP_EMAIL}>`, 
            to: ["ramanandimo457@gmail.com"], // The admin's email address
            subject: `New Contact Form Submission from ${name}`,
            html: `
                <p>Hello,</p>
                <p>You have a new contact form submission with the following details:</p>
                <ul>
                    <li><strong>Full Name:</strong> ${name}</li>
                    <li><strong>Email:</strong> ${email}</li>
                    <li><strong>Phone Number:</strong> ${phone}</li>
                    <li><strong>Business:</strong> ${businessType}</li>
                    <li><strong>Project Details:</strong> ${projectDetails}</li>
                </ul>
                <p>Best regards,<br>Stackcart_Space</p>
            `,
        };

        // Send the email
        await transporter.sendMail(mailOptions);
       // console.log("Admin email sent successfully.");

        // Send a success response after both operations are complete
        res.status(201).json({ success: true, data: newSubmission });
    } catch (error) {
        // Log the full error and send a bad request response
        console.error("Error in contact form submission:", error);
        res.status(400).json({ success: false, error: 'Bad Request' });
    }
};

export { submitContactForm };